const{__:__,_x:_x,_n:_n,_nx:_nx}=wp.i18n;import*as mapbox from"../../../libs/mapbox.js";import Countries from"../../../libs/country_data.min.js";mapboxgl.accessToken="pk.eyJ1IjoibWFya2FzaHRvbiIsImEiOiJjbGRrZGYyc2IwamRuM3ZsZ2JudXdwMjRtIn0.V_oXBXMGBUBty-fZY0VXfg";export default{props:{display:String,name:String,block:Object},data(){return{loading:!0,error:!1,map:!1,apiLoaded:!1,errorMessage:"",total:0,comparisonTotal:0,percentChange:0,fetchingQuery:!1,requestFromGroupDate:!1,currentRequest:!1,startDate:"",endDate:"",currentData:[],groupDate:{},chartData:{data:{main:[],comparison:[]},labels:{main:[],comparisons:[]},title:"",colors:{main:this.returnLineColor,comp:this.returnCompLineColor}},strings:{lastPeriod:__("last period","uipress-pro"),selectDataMetric:__("Please select a chart metric in this block's options to show chart data.","uipress-pro"),changeAccount:__("Switch account","uipress-pro"),count:__("Count","uipress-pro"),change:__("Change","uipress-pro"),current:__("Current","uipress-pro"),previous:__("Previous","uipress-pro"),users:__("users","uipress-pro")}}},inject:["uiTemplate"],watch:{currentData:{handler(){this.buildMap()},immediate:!0,deep:!0},"block.settings.block.options.chartDataType":{handler(t,e){this.getAnalytics()},deep:!0},"uipApp.woocommerce":{handler(t,e){t.ready&&this.getAnalytics()},deep:!0,immediate:!0},"uiTemplate.globalSettings.options.analytics.saveAccountToUser":{handler(t,e){this.refreshAnalytics()}}},mounted(){document.addEventListener("uipress/app/daterange/change",this.handleDateChange)},beforeUnmount(){document.removeEventListener("uipress/app/daterange/change",this.handleDateChange),this.map&&(this.map.remove(),this.map=!1)},computed:{returnTableData(){return this.isObject(this.currentData)?this.currentData:{}},returnMappCss:()=>uipProPath+"assets/css/libs/mapbox.css",returnTotal(){return this.total},returnComparisonTotal(){return this.comparisonTotal},returnChartData(){return this.chartData},returnName(){let t=this.get_block_option(this.block,"block","chartName",!0);return t?t=this.isObject(t)?t.string:t:""},returnChartType(){return this.get_block_option(this.block,"block","chartDataType")},returnChartSettings(){return this.get_block_option(this.block,"block","chartOptions")},returnChartStyle(){let t=this.get_block_option(this.block,"block","chartStyle");return t?t=this.isObject(t)?t.value:"line":"line"},returnLineColor(){let t=this.get_block_option(this.block,"block","chartColour");return t?t=this.isObject(t)?t.value:t:""},returnCompLineColor(){let t=this.get_block_option(this.block,"block","chartCompColour");return t?t=this.isObject(t)?t.value:t:""},hideChart(){let t=this.get_block_option(this.block,"block","hideChart");return t?t=this.isObject(t)?t.value:t:""},inlineAccountSwitch(){let t=this.get_block_option(this.block,"block","inlineAccountSwitch");return!t||(t=this.isObject(t)?t.value:t)},returnRange(){let t=this.get_block_option(this.block,"block","dateRange");return t?t=(t=isNaN(t)?14:t)>60?60:t:14},hasGlobalDate(){return!!this.hasNestedPath(this.groupDate,"start")},isApiReady(){return this.hasNestedPath(this.uipApp,"woocommerce","ready")},darkMapTheme(){let t=this.get_block_option(this.block,"block","darkMode");return!!t&&(t=!!this.isObject(t)&&t.value)}},methods:{handleDateChange(t){t.detail.IDS&&Array.isArray(t.detail.IDS)&&t.detail.IDS.includes(this.block.uid)&&(this.groupDate.start=t.detail.groupDate.start,this.groupDate.end=t.detail.groupDate.end,this.getAnalytics())},returnSymbolTotal(t){if("total_revenue"==this.returnChartType){if("left"==this.currentRequest.data.currency_pos)return this.currentRequest.data.currency+t;if("left_space"==this.currentRequest.data.currency_pos)return this.currentRequest.data.currency+" "+t;if("right"==this.currentRequest.data.currency_pos)return t+this.currentRequest.data.currency;if("right_space"==this.currentRequest.data.currency_pos)return t+" "+this.currentRequest.data.currency}return t},async getAnalytics(){if(this.resetErrorState(),this.apiLoaded=this.isApiReady,!this.apiLoaded)return;this.loading=!0;const{startDate:t,endDate:e}=this.calculateDateRange(),r=await this.fetchAnalyticsData(t,e);r.error?this.handleApiError(r):(this.currentRequest=r,this.processResponse(r)),this.loading=!1},resetErrorState(){this.error=!1,this.errorMessage=""},calculateDateRange(){let t,e;return this.hasGlobalDate?(t=new Date(Date.parse(this.groupDate.start)),e=new Date(Date.parse(this.groupDate.end))):((e=new Date).setDate(e.getDate()-1),(t=new Date).setDate(t.getDate()-this.returnRange)),this.startDate=t,this.endDate=e,{startDate:t,endDate:e}},async fetchAnalyticsData(t,e){return await this.uipApp.woocommerce.api("get",t,e)},handleApiError(t){this.error=!0,this.errorMessage=t.message},processResponse(){let t=this.currentRequest;this.returnChartType&&(t.data.map_data=this.calculateMapPercentages(t.data.map_data),this.currentData=t.data.map_data)},calculateMapPercentages(t){let e=0;const r=this.returnChartType;for(let a in t){e+=t[a][r].total}for(let a in t){let i=t[a][r].total,o=0!==i&&0!==e?(i/e*100).toFixed(2):0;t[a][r].percent_total=o}return t},async removeAnalyticsAccount(){this.uipApp.woocommerce.ready=!1,await this.uipApp.woocommerce.api("removeAccount"),await this.uipApp.woocommerce.api("refresh"),this.uipApp.woocommerce.ready=!0,this.getAnalytics()},async refreshAnalytics(){this.uipApp.woocommerce.ready=!1,await this.uipApp.woocommerce.api("refresh")&&(this.uipApp.woocommerce.ready=!0,this.getAnalytics())},returnFormattedDate(t){if(!t)return"";return`${t.getFullYear()}/${(t.getMonth()+1).toString().padStart(2,"0")}/${t.getDate().toString().padStart(2,"0")}`},returnErrrorMessage(){try{JSON.parse(this.errorMessage)}catch(t){return this.errorMessage}if(this.isObject(JSON.parse(this.errorMessage))){let t=JSON.parse(this.errorMessage);return`\n              <h5 style="margin:0">${t.status}</h5>\n              <p style="margin-bottom:0;">${t.message}</p>\n            `}return this.errorMessage},async buildMap(){await this.$nextTick(),this.map&&(this.map.remove(),this.map=!1);let t="mapbox://styles/markashton/cldkdgzpx008t01rvfdmhtwet";if((this.darkMapTheme||this.uipApp.data.userPrefs.darkTheme)&&(t="mapbox://styles/markashton/cldklav6v009701rv47a1q7pa"),!this.$refs.mapcontainer)return;const e=new mapboxgl.Map({container:"uip-wc-map"+this.block.uid,style:t,zoom:1,center:[-10,14]});this.map=e,e.addControl(new mapboxgl.NavigationControl);let r=Countries;for(const t in this.returnTableData){let a=r.find(e=>e.alpha2.toLowerCase()===t.toLowerCase());if(void 0===a)continue;const i=this.createToolTip(this.returnTableData[t],a);new mapboxgl.Marker(i.el).setLngLat([a.longitude,a.latitude]).setPopup(new mapboxgl.Popup({offset:25}).setHTML(i.inner)).addTo(e)}},createToolTip(t,e){const r=t[this.returnChartType],a=document.createElement("div");a.className="marker uip-w-10 uip-ratio-1-1 uip-background-primary-wash uip-border-circle uip-border-primary";let i=3*r.percent_total;a.style.width=i+"px";let o=r.change<0?"arrow_downward":"";return o=r.change>0?"arrow_upward":o,{el:a,inner:`\n          <div class="uip-background-default uip-boder uip-shadow uip-border-round">\n            <div class="uip-background-default">\n              <div class="uip-padding-xs uip-padding-top-xxs uip-padding-bottom-xxs uip-border-bottom uip-body-font uip-text-left uip-overflow-hidden uip-flex uip-flex-row uip-gap-xs uip-flex-between uip-flex-center">\n              \n                <div class="uip-text-bold uip-text-emphasis">\n                  ${e.country}\n                </div>\n                \n                <div class="uip-text-s uip-background-orange-wash uip-border-round uip-padding-xxxs uip-post-type-label uip-flex uip-gap-xxs uip-flex-center uip-text-bold uip-tag-label uip-text-normal">\n                  <span class="uip-icon">${o}</span>\n                  <span>${r.change}%</span>\n                </div>\n                \n              </div>\n              \n              <div class="uip-padding-xs uip-flex uip-flex-column uip-row-gap-xxs">\n                <div class="uip-flex uip-flex-row uip-gap-xxs uip-flex-between uip-min-w-130">\n                  <div class="uip-text-bold uip-text-primary uip-no-wrap" >${this.returnSymbolTotal(r.total)+" "+r.label}</div>\n                  <div class="uip-text-s uip-text-muted">${this.strings.current}</div>\n                </div>\n                <div class="uip-flex uip-flex-row uip-gap-xxs uip-flex-between uip-min-w-130">\n                  <div class="uip-text-bold uip-text-orange uip-no-wrap">${this.returnSymbolTotal(r.total_comp)+" "+r.label}</div>\n                  <div class="uip-text-s uip-text-muted">${this.strings.previous}</div>\n                </div>\n              </div>\n            </div>\n          </div>`}}},template:'\n  <div class="uip-flex uip-flex-column uip-w-300">\n    \n      <component is="style">\n        @import \'{{returnMappCss}}\';\n        .mapboxgl-ctrl-bottom-left, .mapboxgl-ctrl-bottom-right{\n         display:none; \n        }\n        .marker {\n          border-radius: 50%;\n          cursor: pointer;\n          animation: pulse-outline 2.5s cubic-bezier(0.455, 0.03, 0.515, 0.955) -.4s infinite;\n          transition: outline 5s ease, opacity .2s ease;\n        }\n        @keyframes pulse-outline {\n          0% {\n            outline: 0px solid var(--uip-color-primary-lighter);\n          }\n          100% {\n           outline: 12px solid transparent;\n          }\n        }\n        .mapboxgl-popup {\n          max-width: 200px;\n        }\n        .mapboxgl-popup-content {\n          padding:0;\n          box-shadow:none;\n          border-radius:4px;\n        }\n        .mapboxgl-popup-close-button {\n          top:5px; \n          display:none;\n        }\n        .uip-dark-mode .mapboxgl-ctrl-top-right{\n         filter: invert(1); \n        }\n        .mapboxgl-popup-anchor-top .mapboxgl-popup-tip{\n          border-bottom-color: var(--uip-color-base-0); \n        }\n        .mapboxgl-popup-anchor-bottom .mapboxgl-popup-tip{\n          border-top-color: var(--uip-color-base-0); \n        }\n        .mapboxgl-popup-anchor-left .mapboxgl-popup-tip{\n          border-right-color: var(--uip-color-base-0); \n        }\n        .mapboxgl-popup-anchor-right .mapboxgl-popup-tip{\n          border-left-color: var(--uip-color-base-0); \n        }\n        .mapboxgl-popup-anchor-top-left .mapboxgl-popup-tip{\n          border-bottom-color: var(--uip-color-base-0); \n        }\n        .mapboxgl-popup-anchor-top-right .mapboxgl-popup-tip{\n          border-bottom-color: var(--uip-color-base-0); \n        }\n        .mapboxgl-popup-anchor-bottom-left .mapboxgl-popup-tip{\n          border-top-color: var(--uip-color-base-0); \n        }\n        .mapboxgl-popup-anchor-bottom-right .mapboxgl-popup-tip{\n          border-top-color: var(--uip-color-base-0); \n        }\n        \n      </component>\n      \n      \n      \x3c!-- Header --\x3e\n      <div class="uip-flex uip-flex-between">\n      \n        \x3c!--Chart title--\x3e\n        <div class="uip-margin-bottom-xxs uip-text-normal uip-chart-title">{{returnName}}</div>\n        \n      </div>\n      \n      <div class="uip-text-s uip-text-muted uip-margin-bottom-s uip-margin-bottom-s uip-dates">{{returnFormattedDate(startDate)}} - {{returnFormattedDate(endDate)}}</div>\n      \n      <div v-if="loading" class="uip-padding-m uip-flex uip-flex-center uip-flex-middle  uip-w-100p uip-ratio-16-10 uip-border-box"><loading-chart></loading-chart></div>\n      \n      <div v-else-if="error && errorMessage" class="uip-padding-xs uip-border-round uip-background-orange-wash uip-text-bold uip-margin-bottom-s uip-scale-in-top uip-max-w-100p" v-html="returnErrrorMessage()"></div>\n      \n      <div v-else-if="!returnChartType" class="uip-padding-xxs uip-border-round uip-background-green-wash uip-text-green uip-text-bold uip-margin-bottom-s uip-scale-in-top uip-max-w-200">{{strings.selectDataMetric}}</div>\n      \n        \n      <div v-else class="uip-position-relative uip-h-100p uip-w-100p" \n      :class="{\'uip-dark-mode\' : darkMapTheme || uipApp.data.userPrefs.darkTheme}">\n        <div ref="mapcontainer" :id="\'uip-wc-map\'+block.uid" class="uip-wc-map uip-w-100p uip-h-200"></div>\n      </div>\n      \n     \n      \n  </div>'};