const{__:__,_x:_x,_n:_n,_nx:_nx}=wp.i18n;import*as mapbox from"../../../libs/mapbox.js";import Countries from"../../../libs/country_data.min.js";mapboxgl.accessToken="pk.eyJ1IjoibWFya2FzaHRvbiIsImEiOiJjbGRrZGYyc2IwamRuM3ZsZ2JudXdwMjRtIn0.V_oXBXMGBUBty-fZY0VXfg";const defineAsyncComponent=window.uipress.defineAsyncComponent,uipVersion=window.uipress.proVersion;export default{components:{ConnectFathom:defineAsyncComponent(()=>import(`./fathom-connect-account.min.js?ver=${uipVersion}`))},props:{display:String,name:String,block:Object},data(){return{loading:!0,error:!1,map:!1,apiLoaded:!1,errorMessage:"",total:0,comparisonTotal:0,percentChange:0,fetchingQuery:!1,showFathomConnection:!1,requestFromGroupDate:!1,currentRequest:!1,startDate:"",endDate:"",currentData:[],groupDate:{},chartData:{data:{main:[],comparison:[]},labels:{main:[],comparisons:[]},title:"",colors:{main:this.returnLineColor,comp:this.returnCompLineColor}},strings:{lastPeriod:__("last period","uipress-pro"),selectDataMetric:__("Please select a chart metric in this block's options to show chart data.","uipress-pro"),changeAccount:__("Switch account","uipress-pro"),count:__("Count","uipress-pro"),change:__("Change","uipress-pro"),current:__("Current","uipress-pro"),previous:__("Previous","uipress-pro"),users:__("users","uipress-pro")}}},inject:["uiTemplate"],watch:{currentData:{handler(){this.buildMap()},immediate:!0,deep:!0},"block.settings.block.options.chartDataType":{handler(t,e){this.getAnalytics()},deep:!0},"uipApp.fathomAnalytics":{handler(t,e){t.ready&&this.getAnalytics()},deep:!0,immediate:!0},"uiTemplate.globalSettings.options.analytics.saveAccountToUser":{handler(t,e){this.refreshAnalytics()}}},mounted(){document.addEventListener("uipress/app/daterange/change",this.handleDateChange)},beforeUnmount(){document.removeEventListener("uipress/app/daterange/change",this.handleDateChange),this.map&&(this.map.remove(),this.map=!1)},computed:{returnTableData(){return this.currentData},returnMappCss:()=>uipProPath+"assets/css/libs/mapbox.css",returnTotal(){return this.total},returnComparisonTotal(){return this.comparisonTotal},returnChartData(){return this.chartData},returnName(){let t=this.get_block_option(this.block,"block","chartName",!0);return t?t=this.isObject(t)?t.string:t:""},returnChartType(){return this.get_block_option(this.block,"block","chartDataType")},returnChartSettings(){return this.get_block_option(this.block,"block","chartOptions")},returnChartStyle(){let t=this.get_block_option(this.block,"block","chartStyle");return t?t=this.isObject(t)?t.value:"line":"line"},returnLineColor(){let t=this.get_block_option(this.block,"block","chartColour");return t?t=this.isObject(t)?t.value:t:""},returnCompLineColor(){let t=this.get_block_option(this.block,"block","chartCompColour");return t?t=this.isObject(t)?t.value:t:""},hideChart(){let t=this.get_block_option(this.block,"block","hideChart");return t?t=this.isObject(t)?t.value:t:""},inlineAccountSwitch(){let t=this.get_block_option(this.block,"block","inlineAccountSwitch");return!t||(t=this.isObject(t)?t.value:t)},returnRange(){let t=this.get_block_option(this.block,"block","dateRange");return t?t=(t=isNaN(t)?14:t)>60?60:t:14},hasGlobalDate(){return!!this.hasNestedPath(this.groupDate,"start")},isApiReady(){return this.hasNestedPath(this.uipApp,"fathomAnalytics","ready")},darkMapTheme(){let t=this.get_block_option(this.block,"block","darkMode");return!!t&&(t=!!this.isObject(t)&&t.value)}},methods:{handleDateChange(t){t.detail.IDS&&Array.isArray(t.detail.IDS)&&t.detail.IDS.includes(this.block.uid)&&(this.groupDate.start=t.detail.groupDate.start,this.groupDate.end=t.detail.groupDate.end,this.getAnalytics())},async getAnalytics(){if(this.resetErrorState(),this.apiLoaded=this.isApiReady,!this.apiLoaded)return;this.loading=!0;const{startDate:t,endDate:e}=this.calculateDateRange(),i=await this.fetchAnalyticsData(t,e);i.error?this.handleApiError(i):(this.currentRequest=i,this.processResponse(i)),this.loading=!1},resetErrorState(){this.error=!1,this.errorMessage="",this.showFathomConnection=!1},calculateDateRange(){let t,e;return this.hasGlobalDate?(t=new Date(Date.parse(this.groupDate.start)),e=new Date(Date.parse(this.groupDate.end))):((e=new Date).setDate(e.getDate()-1),(t=new Date).setDate(t.getDate()-this.returnRange)),this.startDate=t,this.endDate=e,{startDate:t,endDate:e}},async fetchAnalyticsData(t,e){return await this.uipApp.fathomAnalytics.api("get",t,e)},handleApiError(t){this.error=!0,this.errorMessage=t.message,"no_account"===t.type&&(this.showFathomConnection=!0)},processResponse(){let t=this.currentRequest;if(!this.returnChartType)return;let e=[],i=0;for(let e of t.country_reports)i+=parseInt(e.visits);for(let a of t.country_reports)a.name=a.country_code,a.value=a.visits,a.percent_total=(a.value/i*100).toFixed(2),e.push(a);this.currentData=e},async removeAnalyticsAccount(){this.uipApp.fathomAnalytics.ready=!1,await this.uipApp.fathomAnalytics.api("removeAccount"),await this.uipApp.fathomAnalytics.api("refresh"),this.uipApp.fathomAnalytics.ready=!0,this.getAnalytics()},async refreshAnalytics(){this.uipApp.fathomAnalytics.ready=!1,await this.uipApp.fathomAnalytics.api("refresh")&&(this.uipApp.fathomAnalytics.ready=!0,this.getAnalytics())},returnFormattedDate(t){if(!t)return"";return`${t.getFullYear()}/${(t.getMonth()+1).toString().padStart(2,"0")}/${t.getDate().toString().padStart(2,"0")}`},returnErrrorMessage(){try{JSON.parse(this.errorMessage)}catch(t){return this.errorMessage}if(this.isObject(JSON.parse(this.errorMessage))){let t=JSON.parse(this.errorMessage);return`\n              <h5 style="margin:0">${t.status}</h5>\n              <p style="margin-bottom:0;">${t.message}</p>\n            `}return this.errorMessage},async buildMap(){await this.$nextTick(),this.map&&(this.map.remove(),this.map=!1);let t="mapbox://styles/markashton/cldkdgzpx008t01rvfdmhtwet";if((this.darkMapTheme||this.uipApp.data.userPrefs.darkTheme)&&(t="mapbox://styles/markashton/cldklav6v009701rv47a1q7pa"),!this.$refs.mapcontainer)return;const e=new mapboxgl.Map({container:"uip-fathom-map",style:t,zoom:1,center:[-10,14]});this.map=e,e.addControl(new mapboxgl.NavigationControl);let i=Countries;for(const t of this.returnTableData){let a=i.find(e=>e.alpha2.toLowerCase()===t.name.toLowerCase());if(void 0===a)continue;const r=this.createToolTip(t);new mapboxgl.Marker(r.el).setLngLat([a.longitude,a.latitude]).setPopup(new mapboxgl.Popup({offset:25}).setHTML(r.inner)).addTo(e)}},createToolTip(t){const e=document.createElement("div");e.className="marker uip-w-10 uip-ratio-1-1 uip-background-primary-wash uip-border-circle uip-border-primary";let i=3*t.percent_total;return e.style.width=i+"px",{el:e,inner:`\n          <div class="uip-background-default uip-boder uip-shadow uip-border-rounder uip-overflow-hidden uip-text-normal">\n            <div class="uip-background-default">\n              <div class="uip-padding-xs uip-padding-top-xxs uip-padding-bottom-xxs uip-border-bottom uip-body-font uip-text-left uip-overflow-hidden uip-flex uip-flex-row uip-gap-xs uip-flex-between uip-flex-center">\n              \n                <div class="uip-text-bold uip-text-emphasis">\n                  ${t.name}\n                </div>\n                \n              </div>\n              \n              <div class="uip-padding-xs uip-flex uip-flex-column uip-row-gap-xxs">\n                <div class="uip-flex uip-flex-row uip-gap-xxs uip-flex-between uip-w-125">\n                  <div class="uip-text-bold uip-text-primary" >${t.value+" "+this.strings.visits}</div>\n                  <div class="uip-text-s uip-text-muted">${this.strings.current}</div>\n                </div>\n              </div>\n            </div>\n          </div>`}}},template:'\n  <div class="uip-flex uip-flex-column uip-w-300">\n    \n      <component is="style">\n        @import \'{{returnMappCss}}\';\n        .mapboxgl-ctrl-bottom-left, .mapboxgl-ctrl-bottom-right{\n         display:none; \n        }\n        .marker {\n          border-radius: 50%;\n          cursor: pointer;\n          animation: pulse-outline 2.5s cubic-bezier(0.455, 0.03, 0.515, 0.955) -.4s infinite;\n          transition: outline 5s ease, opacity .2s ease;\n        }\n        @keyframes pulse-outline {\n          0% {\n            outline: 0px solid var(--uip-color-primary-lighter);\n          }\n          100% {\n           outline: 12px solid transparent;\n          }\n        }\n        .mapboxgl-popup {\n          max-width: 200px;\n        }\n        .mapboxgl-popup-content {\n          padding:0;\n          box-shadow:none;\n          border-radius:4px;\n        }\n        .mapboxgl-popup-close-button {\n          top:5px; \n          display:none;\n        }\n        .uip-dark-mode .mapboxgl-ctrl-top-right{\n         filter: invert(1); \n        }\n        .mapboxgl-popup-anchor-top .mapboxgl-popup-tip{\n          border-bottom-color: var(--uip-color-base-0); \n        }\n        .mapboxgl-popup-anchor-bottom .mapboxgl-popup-tip{\n          border-top-color: var(--uip-color-base-0); \n        }\n        .mapboxgl-popup-anchor-left .mapboxgl-popup-tip{\n          border-right-color: var(--uip-color-base-0); \n        }\n        .mapboxgl-popup-anchor-right .mapboxgl-popup-tip{\n          border-left-color: var(--uip-color-base-0); \n        }\n        .mapboxgl-popup-anchor-top-left .mapboxgl-popup-tip{\n          border-bottom-color: var(--uip-color-base-0); \n        }\n        .mapboxgl-popup-anchor-top-right .mapboxgl-popup-tip{\n          border-bottom-color: var(--uip-color-base-0); \n        }\n        .mapboxgl-popup-anchor-bottom-left .mapboxgl-popup-tip{\n          border-top-color: var(--uip-color-base-0); \n        }\n        .mapboxgl-popup-anchor-bottom-right .mapboxgl-popup-tip{\n          border-top-color: var(--uip-color-base-0); \n        }\n        \n      </component>\n      \n      \n      \x3c!-- Header --\x3e\n      <div class="uip-flex uip-flex-between">\n      \n        \x3c!--Chart title--\x3e\n        <div class="uip-margin-bottom-xxs uip-text-normal uip-chart-title">{{returnName}}</div>\n        \n        \x3c!-- Account switcher--\x3e\n        <dropdown pos="bottom right" v-if="!inlineAccountSwitch && !showFathomConnection">\n          <template v-slot:trigger>\n            <div class="uip-icon uip-link-muted uip-text-l">more_horiz</div>\n          </template>\n          <template v-slot:content>\n            <div class="uip-flex uip-flex-row uip-gap-xxs uip-flex-center uip-padding-xxxs uip-link-muted" @click="removeAnalyticsAccount()">\n              <div class="uip-icon">sync</div>              <div class="uip-padding-xxs">{{strings.changeAccount}}</div>\n            </div>\n          </template>\n        </dropdown>  \n        \n      </div>\n      \n      <div class="uip-text-s uip-text-muted uip-margin-bottom-s uip-margin-bottom-s uip-dates">{{returnFormattedDate(startDate)}} - {{returnFormattedDate(endDate)}}</div>\n      \n      <div class="uip-margin-bottom-xxs" v-if="showFathomConnection"><ConnectFathom :success="refreshAnalytics"/></div>\n      \n      <div v-if="loading" class="uip-padding-m uip-flex uip-flex-center uip-flex-middle  uip-w-100p uip-ratio-16-10 uip-border-box"><loading-chart></loading-chart></div>\n      \n      <div v-else-if="error && errorMessage" class="uip-padding-xs uip-border-round uip-background-orange-wash uip-text-bold uip-margin-bottom-s uip-scale-in-top uip-max-w-100p" v-html="returnErrrorMessage()"></div>\n      \n      <div v-else-if="!returnChartType" class="uip-padding-xxs uip-border-round uip-background-green-wash uip-text-green uip-text-bold uip-margin-bottom-s uip-scale-in-top uip-max-w-200">{{strings.selectDataMetric}}</div>\n      \n        \n      <div v-else class="uip-position-relative uip-h-100p uip-w-100p" \n      :class="{\'uip-dark-mode\' : darkMapTheme || uipApp.data.userPrefs.darkTheme}">\n        <div ref="mapcontainer" id=\'uip-fathom-map\' class="uip-fathom-map uip-w-100p uip-h-200"></div>\n      </div>\n      \n     \n      \n  </div>'};