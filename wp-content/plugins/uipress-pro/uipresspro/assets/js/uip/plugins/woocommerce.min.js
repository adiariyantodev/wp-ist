const{__:__,_x:_x,_n:_n,_nx:_nx}=wp.i18n;export default{data:()=>({ready:!1,hasLicence:!1,noWC:!1,queryURL:!1,reportRunning:!1,token:!1,saveAccountToUser:!1,cache:{},queue:[],dev:!1}),watch:{ready:{handler(e,t){this.uipApp.woocommerce.ready=this.returnStatus},deep:!0}},async mounted(){await this.$nextTick(),this.createQueue(),this.pushToGlobal()},computed:{returnStatus(){return this.ready}},methods:{createQueue(){this.queue=((e,t)=>{const r=[],a=()=>{r[0]&&r[0]().then(function(e){return e}).catch(t).then(()=>r.shift()).then(a).then()};return async e=>{if(r.push(e),1===r.length)return new Promise((e,t)=>{a()})}})()},async pushToGlobal(){this.uipApp.woocommerce={api:this.uipWCAnalytics,ready:this.returnStatus},await this.$nextTick(),this.ready=!0},async uipWCAnalytics(e,t,r){if(this.queryURL||await this.getQueryURL(),!this.hasLicence){let e={error:!0};return e.message=__("No pro licence found. Please add a valid pro licence to use woocommerce analytics","uipress-pro"),e.type="no_licence",e}if(!this.noWC){let e={error:!0};return e.message=__("Woocommerce needs to be active on this site to use woocommerce analytics blocks","uipress-pro"),e.type="no_woocommerce",e}if("get"==e){const e=this.getDates(t,r),a=(e,t)=>new Promise((r,a)=>this.runReport(e,r,t));return await new Promise((t,r)=>{this.queue(()=>a(e,t))})}},async getQueryURL(e){this.cache={},this.hasLicence=!1,this.noWC=!1,this.ready=!1,this.queryURL=!1;let t=new FormData;t.append("action","uip_build_woocommerce_analytics_query"),t.append("security",uip_ajax.security);const r=await this.sendServerRequest(uip_ajax.ajax_url,t);return this.ready=!0,r.error?("no_licence"==r.error_type&&(this.noWC=!0,this.hasLicence=!1,this.queryURL="no_licence"),"no_woocommerce"==r.error_type&&(this.hasLicence=!0,this.noWC=!1,this.queryURL="no_woocommerce"),void 0!==e&&(e(!1),this.queryURL="undefined"),!1):(this.hasLicence=!0,this.noWC=!0,this.queryURL=r.url,void 0!==e&&e(!0),!0)},async runReport(e,t,r){let a=`&sd=${e.startDate}&ed=${e.endDate}&sdc=${e.startDateCom}&edc=${e.endDateCom}`;this.queryURL;if(this.cache[e.startDate+e.endDate])return t(!0),void r(this.cache[e.startDate+e.endDate]);this.reportRunning=!0;let i=new FormData;i.append("action","uip_run_woocommerce_analytics_query"),i.append("security",uip_ajax.security),i.append("dates",JSON.stringify(e));const s=await this.sendServerRequest(uip_ajax.ajax_url,i);if(this.reportRunning=!1,s.error){let e=s.message,a=__("Unable to fetch analytic data","uipress-pro");this.uipApp.notifications.notify(a,e,"error",!0,!1),t(!0),r(s)}this.cache[e.startDate+e.endDate]=s,t(!0),r(s)},getDates(e,t){let r=this.daysDifference(e,t),a={};return a.startDate=this.returnFormattedDate(e),a.endDate=this.returnFormattedDate(t),e.setDate(e.getDate()-1),a.endDateCom=this.returnFormattedDate(e),e.setDate(e.getDate()-r+1),a.startDateCom=this.returnFormattedDate(e),a},returnFormattedDate(e){let t=e.getMonth()+1,r=e.getDate(),a=e.getFullYear();return t<10&&(t="0"+t),r<10&&(r="0"+r),a+"-"+t+"-"+r},daysDifference(e,t){let r=t.getTime()-e.getTime();return Math.round(r/864e5)+1}},template:" "};