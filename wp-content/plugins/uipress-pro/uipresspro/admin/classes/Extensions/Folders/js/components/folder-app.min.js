const{__:__,_x:_x,_n:_n,_nx:_nx}=wp.i18n;export default{props:{parent:[String,Number],list:Array,incrementCount:Function},data:()=>({loading:!1,rendered:!0,baseFolders:[],foldersOpen:!0,dragging:!1,foldersFor:!1,allFiles:0,count:0,table:!1,mediaBrowser:!1,newFolder:{name:"",color:"rgb(108, 76, 203)"},strings:{newFolder:__("New folder","uipress-pro"),folderName:__("Folder name","uipress-pro"),folderColor:__("Folder colour","uipress-pro"),create:__("Create","uipress-pro"),allItems:__("All items","uipress-pro"),folders:__("Folders","uipress-pro"),removeFromFolder:__("Remove from folder","uipress-pro")}}),watch:{activeFolder:{handler(){"posts"==this.foldersFor&&this.filterTableByFolder(),"wpmedia"==this.foldersFor&&this.filterMediaByFolder()},deep:!0}},async created(){await this.$nextTick(),this.getBaseFolders(!0),this.folderMove.handler=this.handleFolderDrag},beforeUnmount(){this.table&&(this.table.removeEventListener("dragstart",this.handlePostTableItemDrag),this.table.addEventListener("dragend",this.handlePostTableItemDragEnd)),this.mediaBrowser&&(this.mediaBrowser.removeEventListener("dragstart",this.handleMediaDragEvent),this.mediaBrowser.addEventListener("dragend",this.handlePostTableItemDragEnd)),document.removeEventListener("uipress/mediamodal/upload/before",this.handleBeforeModalUpload),document.removeEventListener("uipress/mediamodal/upload/added",this.handleAddedModalUpload),document.removeEventListener("uipress/mediamodal/upload/finished",this.handleFinishedModalUpload)},mounted(){this.mountEventListeners()},computed:{requestNewFolderScreen(){return{component:"NewFolder",label:this.strings.newFolder,value:[],list:this.baseFolders,parent:"uipfalse"}},returnFolders(){return this.baseFolders}},methods:{mountEventListeners(){"attachment"==this.postType&&wp.media?(this.foldersFor="wpmedia",this.mountMediaLibraryListeners()):(this.foldersFor="posts",this.mounPostTableListeners())},mounPostTableListeners(){const e=document.querySelector(".wp-list-table");e&&(this.table=e,this.table.addEventListener("dragstart",this.handlePostTableItemDrag),this.table.addEventListener("dragend",this.handlePostTableItemDragEnd))},handlePostTableItemDragEnd(e){this.folderMove.showRemoveFromFolder=!1},handlePostTableItemDrag(e){const t=this.getSelectedFileIds(e);if(0===t.length)return;this.folderMove.showRemoveFromFolder=!0;const r=e.target.getAttribute("data-folder-id");e.dataTransfer.setData("itemID",JSON.stringify(t)),e.dataTransfer.setData("parentFolder",r),this.createDragImage(e,t)},getSelectedFileIds(e){const t=document.querySelectorAll("tbody .check-column input[type=checkbox]:checked");if(t.length>0)return Array.from(t).map(e=>e.value);const r=e.target.getAttribute("data-id");return r?[r]:[]},createDragImage(e,t){const r=__("item","uipress-pro"),i=__("items","uipress-pro"),a=t.length,d=a>1?`${a} ${i}`:`${a} ${r}`,s=document.createElement("div");s.id="uip-content-drag",s.innerHTML=d,s.style.position="absolute",s.style.top="-1000px",document.body.appendChild(s),e.dataTransfer.setDragImage(s,0,0)},mountMediaLibraryListeners(){document.addEventListener("uipress/mediamodal/upload/before",this.handleBeforeModalUpload),document.addEventListener("uipress/mediamodal/upload/finished",this.handleFinishedModalUpload),document.addEventListener("uipress/mediamodal/upload/added",this.handleAddedModalUpload),this.mediaBrowser=document.querySelector(".attachments-browser"),this.mediaBrowser&&(this.mediaBrowser.addEventListener("dragstart",this.handleMediaDragEvent),this.mediaBrowser.addEventListener("dragend",this.handlePostTableItemDragEnd))},handleMediaDragEvent(e){let t=[];this.folderMove.showRemoveFromFolder=!0;let r=document.querySelectorAll(".attachments-browser .attachments .attachment[aria-checked=true]");if(r&&r.length>0)r.forEach(e=>{t.push(e.getAttribute("data-id"))});else{let r=e.target.getAttribute("data-id");if(!r)return;t.push(r)}let i=e.target.getAttribute("data-folder-id");e.dataTransfer.setData("itemID",JSON.stringify(t)),e.dataTransfer.setData("parentFolder",i),this.createDragImage(e,t)},handleBeforeModalUpload(e){const t=e.detail.uploader;e.detail.file;t.settings.multipart_params.uip_folder_id=this.activeFolder.id},handleFinishedModalUpload(e){e.detail.uploader,e.detail.file;this.uipApp.notifications.notify(__("Upload finished ","uipress-lite"),"","success",!0)},handleAddedModalUpload(e){if("all"==this.activeFolder.id)return;e.detail.uploader;const t=e.detail.file,r=wp.media.attachment(t.attachment.id);wp.media.frame.state().get("library").add(r),this.uipApp.notifications.notify(__("File uploaded ","uipress-lite"),t.name,"success",!0)},async getBaseFolders(e){if(this.loading)return;e&&(this.loading=!0);let t=new FormData;t.append("action","uip_folders_get_base_folders"),t.append("security",this.AjaxSecurity),t.append("limitToAuthor",this.limitToAuthor),t.append("postType",this.postType),t.append("limitToType",this.limitToType);const r=await this.sendServerRequest(this.AjaxUrl,t);this.loading=!1,r.error&&this.uipApp.notifications.notify(r.message,"","error",!0),r.success&&(this.baseFolders=[...r.baseFolders],this.allFiles=r.total)},removeFilters(){this.activeFolder.id="all"},deleteFromList(e){let t=this.baseFolders.findIndex(t=>t.id===e);t<0||this.baseFolders.splice(t,1)},handleFolderDrag(e,t){e.added&&this.handleFolderAdded(e,t)},handleFolderAdded(e,t){const r=e.added.element,i=this.isObject(t)?t.id:"uipfalse";this.updateItemFolder(r,i)},async updateItemFolder(e,t){let r=new FormData;r.append("action","uip_folders_update_item_folder"),r.append("security",this.AjaxSecurity),r.append("item",JSON.stringify(e)),r.append("newParent",t);const i=await this.sendServerRequest(this.AjaxUrl,r);i.error?this.uipApp.notifications.notify(i.message,"","error",!0):e.parent=t},async filterTableByFolder(){let e=new URLSearchParams(window.location.search),t=window.location.origin;e.set("uip_folder",this.activeFolder.id);let r=t+window.location.pathname+"?"+e.toString();fetch(r).then(e=>{if(!e.ok)throw new Error("Network response was not ok"+e.statusText);return e.text()}).then(e=>{let t=new DOMParser,r=e.trim(),i=t.parseFromString(r,"text/html").querySelector("#wpbody-content .wrap");document.querySelector("#wpbody-content .wrap").replaceWith(i),this.mounPostTableListeners()}).catch(e=>{console.error("Fetch error: ",e),this.uipApp.notifications.notify(e.message,"","error",!0)})},async filterMediaByFolder(){if(!wp.media)return;let e=this.returnMediaFrameCollection();e&&void 0!==e&&e.props.set({ignore:+new Date,uip_folder_id:this.activeFolder.id})},returnMediaFrameCollection:()=>wp.media.frames.browse?wp.media.frames.browse.content.get().collection:wp.media.frame?wp.media.frame.content.get().collection:void 0,async removeFromFolder(e){const t=this.activeFolder.id;let r=e.dataTransfer.getData("itemID");if(!r)return;if((r=JSON.parse(r)).length<1)return;e.dataTransfer.getData("parentFolder");let i=new FormData;i.append("action","uip_folders_remove_item_from_folder"),i.append("security",this.AjaxSecurity),i.append("IDS",JSON.stringify(r)),i.append("currentFolder",t);const a=await this.sendServerRequest(this.AjaxUrl,i);a.error?this.uipApp.notifications.notify(a.message,"","error",!0):(this.dispatchItemRemoveEvent(r.length),this.folderMove.showRemoveFromFolder=!1,"wpmedia"==this.foldersFor&&this.filterMediaByFolder(),"posts"==this.foldersFor&&this.filterTableByFolder(),this.uipApp.notifications.notify(a.message,"","success",!0))},dispatchItemRemoveEvent(e){const t=this.activeFolder.id,r=new CustomEvent(`uipress/folders/${t}/content/removed`,{detail:{removedCount:e}});document.dispatchEvent(r)}},template:'\n    <div class="uip-max-w-100p uip-flex uip-flex-column uip-row-gap-xs uip-transition-all uip-flex-grow">\n      \n        <div @click="removeFilters()" class="uip-flex uip-flex-row uip-gap-xs uip-flex-center uip-link-default uip-padding-xxs hover:uip-background-muted uip-border-rounder uip-no-text-select uip-text-s" :class="{\'uip-text-emphasis uip-background-muted\' : activeFolder.id == \'all\'}">\n        \n          <div @click.prevent.stop="$emit(\'request-screen\', requestNewFolderScreen)"\n          class="uip-icon uip-link-default">add</div>\n          \n          <div class="uip-flex-grow">{{strings.allItems}}</div>\n          \n          <div class="uip-text-muted uip-padding-right-xxs">{{allFiles}}</div>\n          \n        </div>\n        \n        \n        \n        \n        <div ref="removeFromFolder"\n        @drop.prevent.stop="removeFromFolder($event)" \n        @dragenter.prevent @dragover.prevent\n        v-if="folderMove.showRemoveFromFolder && activeFolder.id && activeFolder.id != \'all\'"\n        class="uip-flex uip-flex-column uip-max-w-100p uip-padding-xxs uip-background-muted uip-border-rounder uip-text-muted uip-text-s uip-text-center uip-fade-in">\n        \n         {{strings.removeFromFolder}}\n        \n        </div>\n      \n      \n        \x3c!--Loading--\x3e\n        <div class="uip-padding-xs uip-flex uip-flex-middle uip-flex-center" v-if="loading"><loading-chart/></div>\n          \n        <template v-else>  \n          \n          <uipDraggable ref="folderList"\n          class="uip-flex uip-flex-column uip-max-w-100p" \n          :group="{ name: \'uip-folders\', pull: true, put: true, revertClone: false }" \n          :list="baseFolders"\n          @change="(evt) => folderMove.handler(evt, false)"\n          ghostClass="uip-canvas-ghost"\n          animation="300"\n          :sort="false">\n          \n            <template v-for="(folder, index) in returnFolders" \n            :key="folder.id" :index="index">\n            \n              <content-folder @request-screen="(d)=> $emit(\'request-screen\', d)" \n              @go-back="$emit(\'go-back\')" \n              :folder="folder" :removeSelf="(id)=>{deleteFromList(id)}"/>\n            \n            </template>\n          \n          </uipDraggable>\n                  \n        \n        </template>\n        \n        \n        \n      \n    </div>\n\t\t'};